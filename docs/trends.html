<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>State Trends â€¢ Trends</title>
  <link rel="icon" href="./favicon.svg" />
  <link rel="stylesheet" href="./styles.css" />
  <style>
    :root{--bg:#0b0b0b;--fg:#f5f5f5;--muted:#a5a5a5;--accent:#66b3ff;--card:#141414;--border:#2a2a2a}
    body{background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
    a{color:var(--accent)}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
    .controls{display:grid;grid-template-columns:repeat(4, minmax(160px,1fr));gap:12px;align-items:end}
    .controls .field{display:flex;flex-direction:column;gap:6px}
    .controls label{font-size:.9rem;color:var(--muted)}
    #chart{width:100%;height:560px}
    .tooltip{position:fixed;pointer-events:none;background:#111;border:1px solid var(--border);padding:8px 10px;border-radius:8px;color:var(--fg);font-size:.95rem;opacity:0;transform:translateY(-6px);transition:opacity .12s ease, transform .12s ease}
    .spacer{height:6px}
    .select-dark{background:var(--card);color:var(--fg);border:1px solid var(--border);padding:6px;border-radius:6px}
    .btn-dark{background:var(--card);color:var(--fg);border:1px solid var(--border);padding:6px 10px;border-radius:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card site-header" style="display:flex;justify-content:space-between;align-items:center;padding:8px;margin-bottom:12px">
      <div class="small-links"><a class="btn" href="./index.html">Home</a><a class="btn" href="./state-pages.html">State Pages</a><a class="btn" href="./ranker.html">Ranker</a><a class="btn" href="./trend-viewer.html">Trend Viewer</a><a class="btn" href="./methods.html">Methods</a><a class="btn" href="./presidential_margins.html">Data (CSV)</a></div>
      <div class="legend">Trends</div>
    </div>

    <div class="card" style="margin-bottom:12px">
      <div class="controls">
        <div class="field">
          <label for="stateSel">State</label>
          <select id="stateSel" class="select-dark"></select>
        </div>
        <div class="field">
          <label for="metricSel">Metric</label>
          <select id="metricSel" class="select-dark">
            <option value="margin" selected>Margin</option>
            <option value="thirdParty">Third-Party Share</option>
          </select>
        </div>
        <div class="field">
          <label>Year range</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="startYear" type="number" style="width:100px" value="1916" step="4" min="1916" max="2024" />
            <span style="color:var(--muted)">to</span>
            <input id="endYear" type="number" style="width:100px" value="2024" step="4" min="1916" max="2024" />
          </div>
        </div>
        <div class="field">
          <label for="chartSel">Chart type</label>
          <select id="chartSel" class="select-dark">
            <option value="auto" selected>Auto</option>
            <option value="line">Line</option>
            <option value="bar">Bar</option>
          </select>
        </div>
        <div class="field">
          <label>Options</label>
          <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="relativeChk" /> Relative</label>
          <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="deltaChk" /> Delta</label>
          <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="twoPartyChk" /> Two-party</label>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:8px">
        <div class="legend">Single-state trends</div>
        <button id="shareBtn" class="btn btn-dark" title="Copy link to this view">Share</button>
      </div>
      <div id="chart"></div>
      <div id="notes" style="margin-top:8px;color:var(--muted);font-size:.92rem"></div>
    </div>

    <footer style="margin-top:16px;color:var(--muted)">
      Trends page (early). This page will expand with embedded controls, a compact table, and accessible keyboard shortcuts.
     <span class="legend">Last updated: 2025-09-19 23:15 UTC</span></footer>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="./utils/siteState.js"></script>
  <script src="./utils/TrendsChart.js"></script>
  <script>
    // Very light glue to wire controls to the shared TrendsChart component
    (function(){
      const el = {
        root: document.getElementById('chart'),
        state: document.getElementById('stateSel'),
        metric: document.getElementById('metricSel'),
        chart: document.getElementById('chartSel'),
        rel: document.getElementById('relativeChk'),
        delta: document.getElementById('deltaChk'),
        twoP: document.getElementById('twoPartyChk'),
        startYear: document.getElementById('startYear'),
        endYear: document.getElementById('endYear'),
        notes: document.getElementById('notes'),
        shareBtn: document.getElementById('shareBtn')
      };

      const csvPath = './presidential_margins.csv';
      let data = null;
      const chart = window.TrendsChart.create(el.root);

      function readFromUrl(){
        const q = new URLSearchParams(location.search);
        if (q.get('s')) el.state.value = q.get('s');
        if (q.get('m')) el.metric.value = q.get('m');
        if (q.get('c')) el.chart.value = q.get('c');
        el.rel.checked = q.has('rel');
        el.delta.checked = q.has('d');
        el.twoP.checked = q.has('tp');
        if (q.get('start')) el.startYear.value = q.get('start');
        if (q.get('end')) el.endYear.value = q.get('end');
      }

      function writeToUrl(){
        const q = new URLSearchParams();
        q.set('s', el.state.value);
        q.set('m', el.metric.value);
        if (el.chart.value !== 'auto') q.set('c', el.chart.value);
        if (el.rel.checked) q.set('rel','1');
        if (el.delta.checked) q.set('d','1');
        if (el.twoP.checked) q.set('tp','1');
        if (el.startYear.value) q.set('start', el.startYear.value);
        if (el.endYear.value) q.set('end', el.endYear.value);
        history.replaceState(null, '', `${location.pathname}?${q.toString()}`);
      }

      function render(){
        if (!data) return;
        chart.update({
          data,
          state: el.state.value,
          metric: el.metric.value,
          chart: el.chart.value,
          rel: el.rel.checked,
          delta: el.delta.checked,
          twoP: el.twoP.checked,
          yearStart: el.startYear.value ? +el.startYear.value : null,
          yearEnd: el.endYear.value ? +el.endYear.value : null,
          notesEl: el.notes
        });
      }

      Promise.all([
        d3.csv(csvPath, d3.autoType)
      ]).then(([rows])=>{
        data = rows;
        // populate states
        const states = Array.from(new Set(rows.map(r=>r.abbr))).filter(s=>s!=='NATIONAL').sort();
        el.state.innerHTML = states.map(s=>`<option value="${s}">${s}</option>`).join('');
        el.state.value = 'AK';
        readFromUrl();

        ;['change','input'].forEach(ev=>{
          [el.state, el.metric, el.chart, el.rel, el.delta, el.twoP, el.startYear, el.endYear]
            .forEach(inp=> inp.addEventListener(ev, ()=>{ writeToUrl(); render(); }));
        });

        if (el.shareBtn && window.SiteState) {
          el.shareBtn.addEventListener('click', function(){
            const url = window.SiteState.copyCurrentUrl();
            el.shareBtn.textContent = 'Copied!';
            setTimeout(()=> el.shareBtn.textContent = 'Share', 1200);
          });
        }

        render();
      });
    })();
  </script>
</body>
</html>
